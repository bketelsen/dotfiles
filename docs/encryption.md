# Encryption & Secrets Management

This repository uses [age](https://github.com/FiloSottile/age) encryption for sensitive files and [Bitwarden CLI](https://bitwarden.com/help/cli/) for runtime secret retrieval.

## Overview

- **Encryption tool:** age (modern, simple encryption)
- **Key location:** `~/.config/chezmoi/key.txt` (private key, never committed)
- **Key type:** X25519 (generated by chezmoi age-keygen)
- **Secret manager:** Bitwarden CLI (optional, for dynamic secrets)

## Initial Setup

On first `chezmoi init` or `chezmoi apply`, a key generation script runs automatically:

1. Checks if age key exists at `~/.config/chezmoi/key.txt`
2. If not, generates a new key using `chezmoi age-keygen`
3. Sets secure permissions (600) on the private key
4. Displays the public key for immediate backup

**After key generation, immediately:**

1. Copy the public key displayed in terminal
2. Update `.chezmoi.toml.tmpl` and replace `PLACEHOLDER_PUBLIC_KEY` with your actual public key
3. Back up your private key (see Backup Procedures below)

### Key Generation Script Location

The automatic key generation is handled by:
`.chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl`

The `run_once_before_00` naming ensures:
- `run_once` - Only runs once (tracked by file hash)
- `before` - Runs before other chezmoi operations
- `00-` - Runs first among before scripts (key must exist before decryption)

## Working with Encrypted Files

### Adding encrypted files

```bash
# Add a file with encryption
chezmoi add --encrypt ~/.netrc

# The file will be stored as encrypted_dot_netrc in the repository
```

### Editing encrypted files

```bash
# Edit decrypts to temp file, opens editor, re-encrypts on save
chezmoi edit ~/.netrc
```

### Viewing encrypted file status

```bash
# See what chezmoi would do
chezmoi diff

# List managed files
chezmoi managed

# List only encrypted files
chezmoi managed | xargs -I{} chezmoi source-path {} | grep encrypted_
```

### Encrypted file naming

Chezmoi prefixes encrypted files with `encrypted_`:
- `~/.netrc` becomes `encrypted_dot_netrc` in the source
- `~/.ssh/config` becomes `encrypted_private_dot_ssh/encrypted_config`

## Bitwarden Integration

Bitwarden CLI is optional but recommended for runtime secret retrieval.

### Configuration

The chezmoi config includes:
```toml
[bitwarden]
    unlock = "auto"
```

This means:
- If `BW_SESSION` environment variable is set, uses existing session
- Otherwise, prompts for master password when needed

### Setup

```bash
# One-time login (per machine)
bw login

# Session is managed automatically by chezmoi (unlock = "auto" in config)
```

### Using in templates

```
# In a .tmpl file, retrieve password:
{{ (bitwarden "item" "my-item-name").login.password }}

# Access custom fields:
{{ (bitwardenFields "item" "my-item-name").field_name.value }}

# Access secure notes:
{{ (bitwarden "item" "my-secure-note").notes }}
```

### Handling Bitwarden unavailability

Templates should gracefully handle missing Bitwarden:

```
{{- if and (lookPath "bw") (env "BW_SESSION") }}
token = {{ (bitwarden "item" "api-key").login.password }}
{{- else }}
# Bitwarden not available - add token manually
token = ""
{{- end }}
```

## Backup Procedures

### Private Key (`~/.config/chezmoi/key.txt`)

**CRITICAL:** This file is the only way to decrypt your encrypted files. Losing it without backup means permanent data loss.

**Recommended backup locations:**

1. **Bitwarden secure note** - Store the entire file contents as a secure note
2. **1Password/other password manager** - As secure note or document
3. **Offline backup** - Encrypted USB drive or printed paper in a safe

**To back up:**

```bash
# Display key for copying
cat ~/.config/chezmoi/key.txt
# Copy the output (entire file, includes AGE-SECRET-KEY-... line)
```

**Backup verification:**

After creating a backup, verify you can read the key from your backup location before relying on it.

### Public Key

The public key (starts with `age1...`) is safe to share and should be:

1. Recorded in `.chezmoi.toml.tmpl` as the `recipient` value
2. Stored alongside private key backup for reference
3. Optionally noted below for quick reference

**Your public key:** `[UPDATE THIS AFTER KEY GENERATION]`

### Backup Checklist

- [ ] Private key backed up to password manager
- [ ] Private key backed up to offline location
- [ ] Public key updated in `.chezmoi.toml.tmpl`
- [ ] Public key noted in this document
- [ ] Backup verified by restoring to different location

## Recovery Scenarios

### Scenario 1: New Machine Setup (Key Backup Available)

If you have your private key backed up, setting up a new machine is straightforward:

1. **Create the chezmoi config directory:**
   ```bash
   mkdir -p ~/.config/chezmoi
   ```

2. **Restore your private key from backup:**
   ```bash
   # Paste your backed-up key (the entire file contents)
   cat > ~/.config/chezmoi/key.txt << 'EOF'
   # created: [timestamp]
   # public key: age1...
   AGE-SECRET-KEY-...
   EOF
   chmod 600 ~/.config/chezmoi/key.txt
   ```

3. **Run the bootstrap or init:**
   ```bash
   # Option A: Full bootstrap
   sh -c "$(curl -fsSL https://raw.githubusercontent.com/YOUR_USERNAME/dotfiles/main/bootstrap.sh)"

   # Option B: If chezmoi already installed
   chezmoi init --apply YOUR_USERNAME/dotfiles
   ```

4. **Verify:**
   ```bash
   chezmoi doctor
   chezmoi diff
   ```

### Scenario 2: Lost Key on One Machine (Backup Available)

If your key was deleted or corrupted but you have a backup:

1. **Retrieve key from backup location** (Bitwarden, USB, paper)

2. **Restore the key:**
   ```bash
   # Restore from backup
   cat > ~/.config/chezmoi/key.txt << 'EOF'
   [paste your backed-up key here]
   EOF
   chmod 600 ~/.config/chezmoi/key.txt
   ```

3. **Verify recovery:**
   ```bash
   chezmoi apply --dry-run
   # Should show no errors related to decryption
   ```

### Scenario 3: Lost Key (NO Backup) - DATA LOSS

**WARNING:** If you lose your private key without backup, all encrypted files are **permanently inaccessible**. This is by design - age encryption cannot be broken.

**If you have another machine with decrypted files:**

1. **On the machine with working files, preserve decrypted content:**
   ```bash
   # Apply to ensure target files exist
   chezmoi apply

   # Copy encrypted file contents while still accessible
   # For example, if ~/.netrc is encrypted:
   cp ~/.netrc ~/netrc-backup.txt
   ```

2. **Generate a new key:**
   ```bash
   rm ~/.config/chezmoi/key.txt
   chezmoi age-keygen --output ~/.config/chezmoi/key.txt
   chmod 600 ~/.config/chezmoi/key.txt
   # Note the new public key displayed!
   ```

3. **Update config with new public key:**
   Edit `.chezmoi.toml.tmpl` and replace the `recipient` value with your new public key

4. **Re-encrypt all affected files:**
   ```bash
   # For each encrypted file, remove from chezmoi and re-add:
   chezmoi forget ~/.netrc
   chezmoi add --encrypt ~/.netrc
   ```

5. **Commit and push changes:**
   ```bash
   cd $(chezmoi source-path)
   git add -A
   git commit -m "Re-encrypt files with new age key"
   git push
   ```

6. **IMMEDIATELY back up your new key!**

**If you have no machine with decrypted files:**

The encrypted data is permanently lost. You will need to:
1. Generate a new key
2. Recreate the encrypted files from scratch
3. Back up the new key immediately

## Verification Commands

Run these to verify your encryption setup:

```bash
# Check chezmoi recognizes encryption config
chezmoi doctor

# Check key file exists
test -f ~/.config/chezmoi/key.txt && echo "Key exists" || echo "Key missing!"

# Check key permissions (should be 600 or -rw-------)
ls -la ~/.config/chezmoi/key.txt

# View public key (safe to share)
grep "public key:" ~/.config/chezmoi/key.txt

# Test decryption works (dry-run)
chezmoi apply --dry-run

# List encrypted files in source
ls -la $(chezmoi source-path) | grep encrypted_
```

## Troubleshooting

### "identity file not found"

The private key is missing from `~/.config/chezmoi/key.txt`.

**Solutions:**
- If first time: Run `chezmoi apply` to trigger key generation script
- If key was lost: Follow recovery procedures above
- Manual generation: `chezmoi age-keygen --output ~/.config/chezmoi/key.txt`

### "no identity matched any of the recipients"

The file was encrypted with a different key than your current private key.

**This means:** Your private key doesn't match the public key used for encryption.

**Solutions:**
- Ensure you're using the correct private key (from backup)
- Check that `.chezmoi.toml.tmpl` recipient matches your actual public key
- If key truly lost, see Scenario 3 above

### "recipient is not valid"

The public key in `.chezmoi.toml.tmpl` is invalid or still set to placeholder.

**Solution:**
1. Check your public key: `grep "public key:" ~/.config/chezmoi/key.txt`
2. Update `.chezmoi.toml.tmpl` recipient field with the actual public key (starts with `age1...`)

### Bitwarden prompts for password repeatedly

**Solutions:**
- Run `bw login` if not logged in
- Run `bw unlock` if session expired
- Export session: `export BW_SESSION=$(bw unlock --raw)`
- The `unlock = "auto"` should handle this, but sometimes requires manual intervention

### Permission denied on key file

The key file needs restrictive permissions.

**Solution:**
```bash
chmod 600 ~/.config/chezmoi/key.txt
```

## Security Notes

### What to protect

- **Never commit `key.txt`** to the repository (already in .gitignore patterns)
- **Never share your private key** except to secure backup locations
- **Never store the private key** in plaintext in cloud storage or notes apps

### What's safe

- **Public keys are safe to share** - they can only encrypt, not decrypt
- **Encrypted files are safe to commit** - that's the entire point
- **The `recipient` in config is the public key** - safe to commit

### Pre-commit protection

This repository includes pre-commit hooks that help prevent accidental secret commits:

- `detect-secrets` scans for potential secrets in staged files
- Files named `encrypted_*` are excluded from scanning (they're encrypted, not plaintext)
- The `.secrets.baseline` tracks known acceptable patterns

To run pre-commit manually:
```bash
pre-commit run --all-files
```

### Bitwarden session security

- Sessions (`BW_SESSION`) expire after inactivity
- Chezmoi's `unlock = "auto"` handles re-authentication automatically
- Never commit or share `BW_SESSION` values
