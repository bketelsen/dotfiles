---
phase: 04-tool-installation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl
  - dot_config/starship.toml
  - dot_config/atuin/config.toml
  - dot_config/bat/config
  - dot_gitconfig.tmpl
  - dot_gitignore_global
autonomous: true

must_haves:
  truths:
    - "chezmoi apply installs CLI tools (starship, atuin, bat, direnv) via Homebrew"
    - "Adding a package to Brewfile triggers reinstallation on next chezmoi apply"
    - "starship config exists at ~/.config/starship.toml with minimal prompt style"
    - "atuin config exists at ~/.config/atuin/config.toml with local-only mode"
    - "bat config exists at ~/.config/bat/config with Nord theme"
    - "git uses custom configuration with sensible defaults and aliases"
  artifacts:
    - path: ".chezmoiscripts/run_onchange_before_install-packages.sh.tmpl"
      provides: "Declarative package installation via Brewfile"
      contains: "brew bundle"
    - path: "dot_config/starship.toml"
      provides: "Starship prompt configuration"
      contains: "git_status"
    - path: "dot_config/atuin/config.toml"
      provides: "Atuin shell history configuration"
      contains: "auto_sync = false"
    - path: "dot_config/bat/config"
      provides: "bat syntax highlighter configuration"
      contains: 'theme="Nord"'
    - path: "dot_gitconfig.tmpl"
      provides: "Git configuration with aliases"
      contains: "[alias]"
    - path: "dot_gitignore_global"
      provides: "Global gitignore patterns"
      contains: ".DS_Store"
  key_links:
    - from: ".chezmoiscripts/run_onchange_before_install-packages.sh.tmpl"
      to: "{{ .homebrew_prefix }}/bin/brew"
      via: "brew bundle command"
      pattern: "homebrew_prefix.*brew bundle"
    - from: "dot_gitconfig.tmpl"
      to: "dot_gitignore_global"
      via: "core.excludesFile reference"
      pattern: "excludesFile.*gitignore_global"
---

<objective>
Install CLI tools declaratively via Homebrew and create configuration files for starship, atuin, bat, direnv, and git.

Purpose: Deliver Phase 4's goal of "CLI tools installed declaratively via Homebrew with cross-platform package lists" per ROADMAP.md success criteria.
Output: run_onchange script with embedded Brewfile, plus individual config files for each tool installed to ~/.config/ and ~/ via chezmoi.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tool-installation/04-CONTEXT.md
@.planning/phases/04-tool-installation/04-RESEARCH.md
@.chezmoi.toml.tmpl
@.chezmoiignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Brewfile with run_onchange script</name>
  <files>.chezmoiscripts/run_onchange_before_install-packages.sh.tmpl</files>
  <action>
Create a run_onchange script that embeds a Brewfile as a heredoc and pipes to brew bundle.

Script requirements:
- Use `#!/bin/sh` and `set -e` for POSIX compatibility (established pattern)
- Use `{{ .homebrew_prefix }}/bin/brew bundle --file=/dev/stdin --no-lock` per user decision
- Embed Brewfile content directly in heredoc (not separate file) per user decision
- Include platform conditionals via chezmoi templating for macOS-only casks

Brewfile content:
- tap "homebrew/bundle"
- brew "starship" (cross-shell prompt)
- brew "atuin" (shell history search)
- brew "bat" (cat with syntax highlighting)
- brew "direnv" (per-directory env vars)
- macOS only: cask "font-meslo-lg-nerd-font" (Nerd font for starship icons)

Add descriptive echo statements before and after brew bundle for visibility.
The script name `run_onchange_before_` ensures it re-runs when content changes.
  </action>
  <verify>
File exists: `ls .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl`
Template syntax valid: `chezmoi execute-template < .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl`
Contains brew bundle: `grep "brew bundle" .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl`
Contains platform conditional: `grep "darwin" .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl`
  </verify>
  <done>
run_onchange script exists with embedded Brewfile containing starship, atuin, bat, direnv, and macOS-conditional Nerd font cask. Template syntax is valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CLI tool configurations</name>
  <files>dot_config/starship.toml, dot_config/atuin/config.toml, dot_config/bat/config</files>
  <action>
Create configuration files for starship, atuin, and bat per user decisions in CONTEXT.md.

**starship.toml** (at dot_config/starship.toml -> ~/.config/starship.toml):
- add_newline = false (cleaner prompt)
- Minimal format: directory + git_branch + git_status + cmd_duration + character
- directory: truncation_length = 3, truncate_to_repo = true
- git_branch: format showing branch with purple style
- git_status: show staged (+), modified (~), untracked (?), ahead/behind counts
- cmd_duration: min_time = 2000 (2 seconds, user decision for "slow commands")
- character: green ">" for success, red ">" for error
- Language modules (python, nodejs, rust, golang): format = 'via [$symbol]($style)' to show symbol without version

**atuin config.toml** (at dot_config/atuin/config.toml -> ~/.config/atuin/config.toml):
- auto_sync = false (user decision: local only mode)
- search_mode = "fuzzy" (user decision)
- filter_mode = "global" (user decision: global deduplication)
- filter_mode_shell_up_key_binding = "global"
- history_filter array to exclude sensitive commands (export, set, secret, password, token patterns)
- show_preview = true, inline_height = 20

**bat config** (at dot_config/bat/config -> ~/.config/bat/config):
- --theme="Nord" (user decision, capital N confirmed)
- --paging=auto
- --style=numbers (user decision: line numbers only)
- --decorations=auto

Create parent directories as needed (dot_config/atuin/).
  </action>
  <verify>
Files exist:
- `ls dot_config/starship.toml`
- `ls dot_config/atuin/config.toml`
- `ls dot_config/bat/config`

Content checks:
- `grep "git_status" dot_config/starship.toml`
- `grep "auto_sync = false" dot_config/atuin/config.toml`
- `grep 'theme="Nord"' dot_config/bat/config`
  </verify>
  <done>
starship.toml has minimal prompt config with git status. atuin config.toml has local-only mode with fuzzy search. bat config has Nord theme with line numbers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Git configuration</name>
  <files>dot_gitconfig.tmpl, dot_gitignore_global</files>
  <action>
Create git configuration files per user decisions in CONTEXT.md.

**dot_gitconfig.tmpl** (-> ~/.gitconfig):
- [user] section with PLACEHOLDER name/email (user overrides locally or via includeIf)
- [init] defaultBranch = main
- [push] default = current, autoSetupRemote = true (user decision)
- [pull] rebase = true (user decision)
- [fetch] prune = true
- [rebase] autoStash = true
- [diff] colorMoved = zebra
- [merge] conflictStyle = diff3
- [core] excludesFile = ~/.gitignore_global
- [alias] section with common shortcuts:
  - s = status -s, st = status
  - d = diff, dc = diff --cached, ds = diff --stat
  - br = branch, co = checkout, cob = checkout -b
  - ci = commit, ca = commit --amend
  - l = log --oneline -20, lg = log --oneline --graph --decorate -20, last = log -1 HEAD --stat
  - undo = reset HEAD~1 --mixed, unstage = reset HEAD --
  - branches = branch -vv

Use .tmpl extension for potential future platform conditionals (macOS credential helper). For now, no platform-specific content needed.

**dot_gitignore_global** (-> ~/.gitignore_global):
- macOS: .DS_Store, **/.DS_Store, .AppleDouble, .LSOverride, ._*
- Linux: *~, .directory
- Editors: *.swp, *.swo, *.swn, .vscode/settings.json, .vscode/launch.json, .idea/
- Temp files: *.tmp, *.temp, *.log, *.bak
  </action>
  <verify>
Files exist:
- `ls dot_gitconfig.tmpl`
- `ls dot_gitignore_global`

Content checks:
- `grep "push.default" dot_gitconfig.tmpl || grep "default = current" dot_gitconfig.tmpl`
- `grep "pull.rebase" dot_gitconfig.tmpl || grep "rebase = true" dot_gitconfig.tmpl`
- `grep "\[alias\]" dot_gitconfig.tmpl`
- `grep "excludesFile" dot_gitconfig.tmpl`
- `grep "DS_Store" dot_gitignore_global`
  </verify>
  <done>
gitconfig has push.default=current, pull.rebase=true, common aliases, and references gitignore_global. gitignore_global has OS and editor patterns.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Template validation:**
   ```bash
   chezmoi execute-template < .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl
   ```
   Should output valid shell script with resolved homebrew_prefix

2. **File structure:**
   ```bash
   ls -la .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl
   ls -la dot_config/starship.toml
   ls -la dot_config/atuin/config.toml
   ls -la dot_config/bat/config
   ls -la dot_gitconfig.tmpl
   ls -la dot_gitignore_global
   ```
   All 6 files should exist

3. **chezmoi status:**
   ```bash
   chezmoi status
   ```
   Should show new files ready to apply (not errors)

4. **Key content verification:**
   - Brewfile has all 4 tools: starship, atuin, bat, direnv
   - starship config has minimal format with git status
   - atuin config has auto_sync = false
   - bat config has Nord theme
   - gitconfig has rebase and aliases
   - gitignore_global has .DS_Store
</verification>

<success_criteria>
Phase 4 Success Criteria (from ROADMAP.md):
1. [x] starship prompt config exists with custom configuration (TOOL-01)
2. [x] atuin config exists with optimal defaults (TOOL-02)
3. [x] bat config exists with syntax highlighting theme (TOOL-03)
4. [x] direnv included in Brewfile (TOOL-04) - shell hook is Phase 5
5. [x] Git configured with sensible defaults (TOOL-05)

Note: Shell integration (eval commands for starship/atuin/direnv) belongs to Phase 5 per CONTEXT.md boundary.
</success_criteria>

<output>
After completion, create `.planning/phases/04-tool-installation/04-01-SUMMARY.md` using the summary template.

Include in summary:
- All 6 files created
- Key decisions made (any discretionary choices like specific git aliases)
- Phase 5 integration notes (shell hooks needed)
- Verification that chezmoi status shows files ready
</output>
