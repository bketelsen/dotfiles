---
phase: 02-encryption-secrets
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .pre-commit-config.yaml
  - .secrets.baseline
autonomous: true

must_haves:
  truths:
    - "Pre-commit hook blocks commits containing potential secrets"
    - "Encrypted files (encrypted_*) are excluded from secret scanning"
    - "Pre-commit runs automatically on git commit"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit hook configuration with detect-secrets"
      contains: "detect-secrets"
    - path: ".secrets.baseline"
      provides: "Baseline of known acceptable patterns"
      min_lines: 1
  key_links:
    - from: ".pre-commit-config.yaml"
      to: "git hooks"
      via: "pre-commit install"
      pattern: "hooks:"
---

<objective>
Set up pre-commit hooks with detect-secrets to prevent accidental commits of plaintext secrets.

Purpose: Provide a safety net against human error when managing encrypted files. The hook will scan staged files for potential secrets and block commits if any are detected (except for already-encrypted files).

Output:
- `.pre-commit-config.yaml` with detect-secrets hook configuration
- `.secrets.baseline` file for known acceptable patterns
- Git hooks installed and active
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-encryption-secrets/02-CONTEXT.md
@.planning/phases/02-encryption-secrets/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-commit configuration</name>
  <files>.pre-commit-config.yaml</files>
  <action>
Create `.pre-commit-config.yaml` with detect-secrets hook:

```yaml
# Pre-commit hooks for secret detection
# https://pre-commit.com/
# https://github.com/Yelp/detect-secrets

repos:
  # Detect secrets to prevent accidental commits
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        args:
          - '--baseline'
          - '.secrets.baseline'
        # Exclude already-encrypted files and common false positives
        exclude: |
          (?x)(
            ^encrypted_.*|
            \.secrets\.baseline$
          )

  # Standard pre-commit hooks for code quality
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-added-large-files
        args: ['--maxkb=500']
      - id: check-merge-conflict
      - id: end-of-file-fixer
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
      - id: check-yaml
      - id: check-toml
```

Key points:
- detect-secrets v1.5.0 is the latest stable version
- Exclude `encrypted_*` files (already protected by age encryption)
- Exclude `.secrets.baseline` itself
- Include standard pre-commit hooks for general code quality
- check-yaml and check-toml will help catch config syntax errors
  </action>
  <verify>
1. File exists: `test -f .pre-commit-config.yaml && echo "exists"`
2. Valid YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.pre-commit-config.yaml'))"`
3. Contains detect-secrets: `grep -q "detect-secrets" .pre-commit-config.yaml && echo "has detect-secrets"`
  </verify>
  <done>
.pre-commit-config.yaml exists with detect-secrets hook and standard code quality hooks
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate secrets baseline and install hooks</name>
  <files>.secrets.baseline</files>
  <action>
1. Check if detect-secrets is installed, install if needed:
   ```bash
   command -v detect-secrets || pip install detect-secrets
   ```

2. Generate initial secrets baseline by scanning the repository:
   ```bash
   detect-secrets scan > .secrets.baseline
   ```

   This creates a baseline of the current state. Any existing "secrets" (like example keys in documentation) will be recorded so they don't trigger false positives.

3. Check if pre-commit is installed, install if needed:
   ```bash
   command -v pre-commit || pip install pre-commit
   ```

4. Install the git hooks:
   ```bash
   pre-commit install
   ```

   This creates `.git/hooks/pre-commit` that runs on every commit.

5. Run pre-commit on all files to verify it works:
   ```bash
   pre-commit run --all-files
   ```

   Note: Some hooks may modify files (trailing whitespace, end-of-file-fixer). This is expected and those changes should be committed.

Note on installation: If pip is not available, try `brew install detect-secrets pre-commit` or document the requirement for user to install.
  </action>
  <verify>
1. Baseline exists: `test -f .secrets.baseline && echo "baseline exists"`
2. Baseline is valid JSON: `python3 -c "import json; json.load(open('.secrets.baseline'))"`
3. Hooks installed: `test -f .git/hooks/pre-commit && echo "hooks installed"`
4. Pre-commit runs: `pre-commit run --all-files` (should pass or show only expected fixes)
  </verify>
  <done>
.secrets.baseline generated with current repository state, git hooks installed and active
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Config exists:** `.pre-commit-config.yaml` present with detect-secrets hook
2. **Baseline exists:** `.secrets.baseline` present with scanned results
3. **Hooks active:** `.git/hooks/pre-commit` exists and is executable
4. **Hooks work:** `pre-commit run --all-files` completes (pass or fix mode)
5. **Test detection:** Creating a file with `password = "secret123"` and staging it should trigger detect-secrets warning
</verification>

<success_criteria>
- [ ] `.pre-commit-config.yaml` created with detect-secrets v1.5.0
- [ ] `.pre-commit-config.yaml` excludes `encrypted_*` files
- [ ] `.secrets.baseline` generated from current repository
- [ ] `pre-commit install` completed successfully
- [ ] `pre-commit run --all-files` passes
- [ ] Git hooks are active in `.git/hooks/`
</success_criteria>

<output>
After completion, create `.planning/phases/02-encryption-secrets/02-02-SUMMARY.md`
</output>
