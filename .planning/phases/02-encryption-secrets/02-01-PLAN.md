---
phase: 02-encryption-secrets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .chezmoi.toml.tmpl
  - .chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl
autonomous: true

must_haves:
  truths:
    - "chezmoi add --encrypt works after configuration"
    - "chezmoi apply decrypts encrypted files automatically"
    - "Age key is generated on first-time setup if missing"
    - "Bitwarden secrets can be accessed in chezmoi templates"
  artifacts:
    - path: ".chezmoi.toml.tmpl"
      provides: "Age encryption and Bitwarden configuration"
      contains: "encryption = \"age\""
    - path: ".chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl"
      provides: "Automatic age key generation on first setup"
      min_lines: 20
  key_links:
    - from: ".chezmoi.toml.tmpl"
      to: "~/.config/chezmoi/key.txt"
      via: "age.identity configuration"
      pattern: "identity.*chezmoi/key.txt"
    - from: ".chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl"
      to: "chezmoi age-keygen"
      via: "key generation command"
      pattern: "chezmoi age-keygen"
---

<objective>
Configure age encryption and Bitwarden CLI integration for chezmoi dotfiles management.

Purpose: Enable secure storage of sensitive configuration files (API keys, tokens, SSH keys) in the repository while allowing retrieval of dynamic secrets from Bitwarden during template expansion.

Output:
- Updated `.chezmoi.toml.tmpl` with age encryption and Bitwarden configuration
- Key generation script that runs automatically on first-time setup
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-encryption-secrets/02-CONTEXT.md
@.planning/phases/02-encryption-secrets/02-RESEARCH.md
@.chezmoi.toml.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure age encryption in chezmoi</name>
  <files>.chezmoi.toml.tmpl</files>
  <action>
Update the existing `.chezmoi.toml.tmpl` to add age encryption configuration:

1. Add `encryption = "age"` at the TOP of the file BEFORE any other sections (critical - must be first)
2. Add `[age]` section with:
   - `identity = "{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt"` (private key location)
   - `recipient = "PLACEHOLDER_PUBLIC_KEY"` with a comment explaining user must update after key generation
3. Add `[bitwarden]` section with:
   - `unlock = "auto"` (only prompts if BW_SESSION not already set)
4. Keep existing `[data]` section and `sourceDir` configuration
5. Add comments explaining each section

CRITICAL: The `encryption = "age"` line MUST be at the very top, before any `[section]` markers. This is a chezmoi requirement - encryption config is ignored if placed after other sections.

The config structure must be:
```
encryption = "age"

[age]
    identity = ...
    recipient = ...

[bitwarden]
    unlock = ...

[data]
    ...
```
  </action>
  <verify>
Run `cat .chezmoi.toml.tmpl` and verify:
1. First non-comment line is `encryption = "age"`
2. `[age]` section exists with identity and recipient
3. `[bitwarden]` section exists with unlock = "auto"
4. No syntax errors in TOML format
  </verify>
  <done>
.chezmoi.toml.tmpl contains complete age and bitwarden configuration with encryption directive at top level
  </done>
</task>

<task type="auto">
  <name>Task 2: Create age key generation script</name>
  <files>.chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl</files>
  <action>
Create the directory `.chezmoiscripts/` and add the key generation script:

1. Create `.chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl`
2. Script requirements:
   - Shebang: `#!/bin/sh` (POSIX compatible, matching Phase 1 patterns)
   - `set -e` for fail-fast
   - KEY_FILE variable using chezmoi template: `{{ .chezmoi.homeDir }}/.config/chezmoi/key.txt`
   - Check if key already exists - if so, print message and exit 0 (idempotent)
   - If key doesn't exist:
     a. Create parent directory with `mkdir -p`
     b. Run `chezmoi age-keygen --output="$KEY_FILE"` and capture output
     c. Extract public key from output (grep "Public key:" | awk '{print $3}')
     d. Set permissions to 600 with `chmod`
     e. Print success message with public key
     f. Print IMPORTANT backup instructions
3. Use plain echo (no emojis) for output messages
4. Include helpful comments explaining the script's purpose

The script name uses `run_once_before_00-` prefix which means:
- `run_once`: Only runs if hash changes (first time or script modification)
- `before`: Runs before other chezmoi operations
- `00-`: Runs first among before scripts (ensures key exists before decryption needed)
  </action>
  <verify>
1. Directory exists: `ls -la .chezmoiscripts/`
2. Script exists with correct name: `ls .chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl`
3. Script is syntactically valid: `sh -n .chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl` (will have template errors but shell syntax should be valid)
4. Script contains key elements: `grep -E "(chezmoi age-keygen|chmod 600|mkdir -p)" .chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl`
  </verify>
  <done>
Key generation script exists in .chezmoiscripts/ with idempotent behavior, correct permissions handling, and backup instructions
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify encryption workflow works</name>
  <files></files>
  <action>
Verify the encryption setup by testing the workflow (without modifying additional files):

1. Check chezmoi recognizes the new configuration:
   - Run `chezmoi doctor` to verify no configuration errors
   - Run `chezmoi data` to verify template variables are accessible

2. Test that encryption would work (dry run):
   - Create a temporary test file: `echo "test secret" > /tmp/test-secret.txt`
   - Run `chezmoi add --encrypt --dry-run /tmp/test-secret.txt` to verify encryption works
   - Clean up: `rm /tmp/test-secret.txt`

3. If age key doesn't exist yet (expected on fresh setup), verify the error message is clear

Note: Full encryption testing requires an actual age key, which will be generated by the run_once script on first `chezmoi apply`. This task verifies configuration is correct, not end-to-end encryption.
  </action>
  <verify>
1. `chezmoi doctor` shows no critical errors related to encryption configuration
2. `chezmoi data` outputs valid JSON with chezmoi variables
3. Either `chezmoi add --encrypt --dry-run /tmp/test-secret.txt` succeeds, OR the error clearly indicates "identity file not found" (expected if key not yet generated)
  </verify>
  <done>
Chezmoi configuration is valid and encryption workflow is ready (key generation will complete on first apply)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Configuration valid:** `chezmoi doctor` reports no errors (or only expected warnings about missing key)
2. **Encryption configured:** `.chezmoi.toml.tmpl` has `encryption = "age"` as first directive
3. **Key script ready:** `.chezmoiscripts/run_once_before_00-setup-age-key.sh.tmpl` exists and is syntactically valid
4. **Bitwarden configured:** `[bitwarden]` section with `unlock = "auto"` in config

Note: Actual encryption/decryption testing requires a generated key. The key generation script runs on first `chezmoi init` or `chezmoi apply`, which is the intended workflow.
</verification>

<success_criteria>
- [ ] `.chezmoi.toml.tmpl` updated with age encryption at top level
- [ ] `.chezmoi.toml.tmpl` has [age] section with identity and recipient
- [ ] `.chezmoi.toml.tmpl` has [bitwarden] section with unlock = "auto"
- [ ] `.chezmoiscripts/` directory created
- [ ] Key generation script created with correct naming convention
- [ ] Script is idempotent (checks for existing key)
- [ ] Script displays public key for backup
- [ ] `chezmoi doctor` shows no configuration errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-encryption-secrets/02-01-SUMMARY.md`
</output>
