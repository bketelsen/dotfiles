---
phase: 02-encryption-secrets
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - docs/encryption.md
autonomous: true

must_haves:
  truths:
    - "Recovery procedures are documented for key loss scenarios"
    - "Backup instructions are clear and actionable"
    - "New machine setup procedure is documented"
  artifacts:
    - path: "docs/encryption.md"
      provides: "Encryption setup and recovery documentation"
      min_lines: 50
  key_links:
    - from: "docs/encryption.md"
      to: "~/.config/chezmoi/key.txt"
      via: "backup and recovery procedures"
      pattern: "key.txt"
---

<objective>
Create comprehensive documentation for age encryption setup, backup procedures, and recovery scenarios.

Purpose: Ensure the user can recover from key loss scenarios and set up new machines correctly. This documentation is critical because losing the age private key without a backup means all encrypted files become permanently inaccessible.

Output:
- `docs/encryption.md` with complete encryption and recovery documentation
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-encryption-secrets/02-CONTEXT.md
@.planning/phases/02-encryption-secrets/02-RESEARCH.md
@.planning/phases/02-encryption-secrets/02-01-SUMMARY.md
@.chezmoi.toml.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create encryption documentation</name>
  <files>docs/encryption.md</files>
  <action>
Create `docs/` directory and `docs/encryption.md` with the following sections:

```markdown
# Encryption & Secrets Management

This repository uses [age](https://github.com/FiloSottile/age) encryption for sensitive files and [Bitwarden CLI](https://bitwarden.com/help/cli/) for runtime secret retrieval.

## Overview

- **Encryption tool:** age (modern, simple encryption)
- **Key location:** `~/.config/chezmoi/key.txt` (private key, never committed)
- **Key type:** X25519 (generated by age-keygen)
- **Secret manager:** Bitwarden CLI (optional, for dynamic secrets)

## Initial Setup

On first `chezmoi init` or `chezmoi apply`, a key generation script runs automatically:

1. Checks if age key exists at `~/.config/chezmoi/key.txt`
2. If not, generates a new key using `chezmoi age-keygen`
3. Displays the public key for immediate backup

**After key generation, immediately:**
1. Copy the public key displayed in terminal
2. Update `.chezmoi.toml.tmpl` with your actual public key (replace PLACEHOLDER)
3. Back up your private key (see Backup Procedures below)

## Working with Encrypted Files

### Adding encrypted files

```bash
# Add a file with encryption
chezmoi add --encrypt ~/.netrc

# The file will be stored as encrypted_dot_netrc in the repository
```

### Editing encrypted files

```bash
# Edit decrypts to temp file, opens editor, re-encrypts on save
chezmoi edit ~/.netrc
```

### Viewing encrypted file status

```bash
# See what chezmoi would do
chezmoi diff

# List managed files
chezmoi managed
```

## Bitwarden Integration

Bitwarden CLI is optional. If configured and logged in, templates can retrieve secrets:

### Setup

```bash
# One-time login (per machine)
bw login

# Session is managed automatically by chezmoi (unlock = "auto" in config)
```

### Using in templates

```
# In a .tmpl file:
{{ (bitwarden "item" "my-item-name").login.password }}

# Access custom fields:
{{ (bitwardenFields "item" "my-item-name").field_name.value }}
```

### If Bitwarden unavailable

Templates should handle missing Bitwarden gracefully:

```
{{- if and (lookPath "bw") (env "BW_SESSION") }}
token = {{ (bitwarden "item" "api-key").login.password }}
{{- else }}
# Bitwarden not available - add token manually
token = ""
{{- end }}
```

## Backup Procedures

### Private Key (`~/.config/chezmoi/key.txt`)

**CRITICAL:** This file is the only way to decrypt your encrypted files. Losing it without backup means permanent data loss.

**Recommended backup locations:**
1. **Bitwarden secure note** - Store the entire file contents
2. **Offline backup** - Encrypted USB drive or printed paper in a safe
3. **1Password/other password manager** - As secure note

**To back up:**
```bash
cat ~/.config/chezmoi/key.txt
# Copy the output (starts with AGE-SECRET-KEY-...)
```

### Public Key

The public key (starts with `age1...`) is safe to share and should be:
1. Recorded in `.chezmoi.toml.tmpl` as the recipient
2. Noted in this document (see below)
3. Stored alongside private key backup for reference

**Your public key:** `[UPDATE THIS AFTER KEY GENERATION]`

## Recovery Scenarios

### Scenario 1: New Machine Setup (Key Exists)

If you have your private key backed up:

1. Create the chezmoi config directory:
   ```bash
   mkdir -p ~/.config/chezmoi
   ```

2. Copy your private key:
   ```bash
   # Paste your backed-up key
   cat > ~/.config/chezmoi/key.txt << 'EOF'
   # AGE-SECRET-KEY-... (paste your key here)
   EOF
   chmod 600 ~/.config/chezmoi/key.txt
   ```

3. Initialize chezmoi:
   ```bash
   chezmoi init --apply YOUR_GITHUB_USERNAME/dotfiles
   ```

### Scenario 2: Lost Key (Backup Available)

1. Retrieve key from backup location (Bitwarden, USB, paper)
2. Follow "New Machine Setup" procedure above
3. Verify: `chezmoi apply --dry-run` should show no errors

### Scenario 3: Lost Key (NO Backup) - DATA LOSS

**WARNING:** If you lose your private key without backup, all encrypted files are **permanently inaccessible**.

Recovery steps (on a machine where files are already decrypted):

1. **First, preserve decrypted files:**
   ```bash
   chezmoi apply  # Apply current state to ensure files exist
   ```

2. **Generate new key:**
   ```bash
   rm ~/.config/chezmoi/key.txt
   chezmoi age-keygen --output ~/.config/chezmoi/key.txt
   # Note the new public key!
   ```

3. **Update config with new public key:**
   Edit `.chezmoi.toml.tmpl` and replace the recipient

4. **Re-encrypt all files:**
   ```bash
   # For each encrypted file, remove and re-add:
   chezmoi forget ~/.netrc
   chezmoi add --encrypt ~/.netrc
   ```

5. **Back up your new key immediately!**

## Verifying Encryption Setup

Run this to verify your setup:

```bash
# Check age is installed
which age

# Check key exists
test -f ~/.config/chezmoi/key.txt && echo "Key exists"

# Check key permissions (should be 600)
stat ~/.config/chezmoi/key.txt

# Check chezmoi recognizes encryption
chezmoi doctor
```

## Troubleshooting

### "identity file not found"

The private key is missing. Either:
- Run `chezmoi apply` to trigger key generation script
- Or manually create key: `chezmoi age-keygen --output ~/.config/chezmoi/key.txt`

### "no identity matched any of the recipients"

The file was encrypted with a different key. You need the original private key that matches the public key used during encryption.

### Bitwarden prompts for password

Either:
- Run `bw login` first (one-time per machine)
- Or `bw unlock` if already logged in but session expired
- The `unlock = "auto"` config should handle this automatically

## Security Notes

- **Never commit `key.txt`** to the repository
- **Never share your private key** except to secure backup locations
- **Public keys are safe to share** - they can only encrypt, not decrypt
- **Pre-commit hooks** help prevent accidental secret commits
- **Bitwarden sessions** expire - chezmoi handles re-authentication automatically
```

Adjust the documentation based on the actual configuration created in Plan 02-01.
  </action>
  <verify>
1. Directory exists: `test -d docs && echo "docs dir exists"`
2. File exists: `test -f docs/encryption.md && echo "encryption.md exists"`
3. Has key sections: `grep -c "## " docs/encryption.md` (should be 8+ sections)
4. Documents key location: `grep -q "key.txt" docs/encryption.md && echo "documents key location"`
5. Has recovery scenarios: `grep -q "Scenario" docs/encryption.md && echo "has recovery scenarios"`
  </verify>
  <done>
docs/encryption.md exists with complete setup, backup, and recovery documentation
  </done>
</task>

<task type="auto">
  <name>Task 2: Update README with encryption reference</name>
  <files>README.md</files>
  <action>
Update the existing README.md to add a section about encryption:

1. Read current README.md
2. Add a new section after the Quick Start section:

```markdown
## Encryption & Secrets

This repository uses age encryption for sensitive files. On first setup:

1. An age encryption key is automatically generated
2. The public key is displayed - **back it up immediately**
3. See [docs/encryption.md](docs/encryption.md) for full documentation

### Important

- Back up your age key to Bitwarden or another secure location
- Without the key backup, encrypted files cannot be recovered
```

Keep the existing content intact, just add the encryption section.
  </action>
  <verify>
1. README updated: `grep -q "Encryption" README.md && echo "has encryption section"`
2. Links to docs: `grep -q "docs/encryption.md" README.md && echo "links to docs"`
  </verify>
  <done>
README.md updated with encryption section linking to detailed documentation
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Docs directory exists:** `docs/` created
2. **Encryption docs complete:** `docs/encryption.md` has all required sections
3. **README updated:** Points users to encryption documentation
4. **Documentation accurate:** Procedures match actual configuration from Plan 02-01
</verification>

<success_criteria>
- [ ] `docs/` directory created
- [ ] `docs/encryption.md` created with 50+ lines
- [ ] Documentation covers initial setup
- [ ] Documentation covers backup procedures
- [ ] Documentation covers all three recovery scenarios
- [ ] Documentation covers Bitwarden integration
- [ ] Documentation covers troubleshooting
- [ ] README.md updated with encryption section
- [ ] README links to docs/encryption.md
</success_criteria>

<output>
After completion, create `.planning/phases/02-encryption-secrets/02-03-SUMMARY.md`
</output>
