---
phase: 03-cross-platform-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .chezmoi.toml.tmpl
  - .chezmoiignore
autonomous: true

must_haves:
  truths:
    - "chezmoi apply fails loudly on unsupported OS (not darwin or linux)"
    - "chezmoi apply fails loudly on unsupported macOS architecture (not arm64)"
    - "Templates can access {{ .homebrew_prefix }} variable with correct platform path"
    - ".chezmoiignore template exists with platform exclusion infrastructure"
  artifacts:
    - path: ".chezmoi.toml.tmpl"
      provides: "Platform detection with Homebrew prefix computation"
      contains: "homebrew_prefix"
    - path: ".chezmoiignore"
      provides: "Platform-specific file exclusion template"
      contains: ".chezmoi.os"
  key_links:
    - from: ".chezmoi.toml.tmpl"
      to: "[data] section"
      via: "homebrew_prefix variable assignment"
      pattern: 'homebrew_prefix\s*=\s*"'
---

<objective>
Add cross-platform detection infrastructure to chezmoi configuration

Purpose: Enable all future templates to adapt based on operating system and architecture. This is foundational infrastructure that later phases (tool installation, shell configuration) will build upon.

Output: Platform-aware .chezmoi.toml.tmpl with Homebrew prefix detection and .chezmoiignore template for platform-specific file handling.
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-cross-platform-support/03-RESEARCH.md
@.chezmoi.toml.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add platform detection to chezmoi config</name>
  <files>.chezmoi.toml.tmpl</files>
  <action>
Update .chezmoi.toml.tmpl to:

1. Add platform validation at the TOP of the file (before any config):
   - Fail if OS is not darwin or linux: `{{ fail "Unsupported OS: ..." }}`
   - Fail if darwin but arch is not arm64: `{{ fail "Unsupported macOS architecture: ..." }}`
   - Include detected OS and arch in error messages for debugging

2. Compute Homebrew prefix based on OS/arch:
   - darwin + arm64 = /opt/homebrew
   - linux = /home/linuxbrew/.linuxbrew
   - Store in `$homebrewPrefix` variable

3. Add to [data] section:
   - homebrew_prefix = computed value

Use proper whitespace trimming with `{{-` and `-}}` to avoid blank lines.

Error messages should be helpful:
- "Unsupported OS: detected [os], only darwin and linux are supported"
- "Unsupported macOS architecture: detected [arch], only arm64 (Apple Silicon) is supported"

IMPORTANT: Keep existing encryption, [age], [bitwarden], and sourceDir config intact. Only add platform detection and [data].homebrew_prefix.
  </action>
  <verify>
Run: `chezmoi execute-template "{{ .homebrew_prefix }}"`
Expected: Returns correct path for current platform (/home/linuxbrew/.linuxbrew on Linux)

Run: `chezmoi data --format=yaml | grep homebrew_prefix`
Expected: Shows homebrew_prefix with correct value
  </verify>
  <done>
- Platform validation blocks unsupported configurations
- homebrew_prefix is accessible in templates with correct path per platform
- Existing encryption configuration unchanged
  </done>
</task>

<task type="auto">
  <name>Task 2: Create .chezmoiignore template</name>
  <files>.chezmoiignore</files>
  <action>
Create .chezmoiignore file (NOT .chezmoiignore.tmpl - chezmoi processes it as template automatically).

Content structure:

1. Header comment explaining the file's purpose and the CRITICAL logic inversion:
   - .chezmoiignore IGNORES matching patterns
   - To include file only on darwin: use `{{ if ne .chezmoi.os "darwin" }}` (ignore if NOT darwin)
   - Common mistake: using `{{ if eq ... }}` which does the opposite

2. macOS-only files section (ignored on Linux):
   ```
   {{- if ne .chezmoi.os "darwin" }}
   # macOS-only files (ignored on Linux)
   Library/
   {{- end }}
   ```

3. Linux-only files section (ignored on macOS):
   ```
   {{- if ne .chezmoi.os "linux" }}
   # Linux-only files (ignored on macOS)
   .xinitrc
   .Xresources
   {{- end }}
   ```

4. Always ignore section (both platforms):
   - .planning/ (planning docs)
   - bootstrap.sh (used for initial setup only)
   - README.md (repo documentation)
   - .pre-commit-config.yaml (dev tooling)
   - .secrets.baseline (dev tooling)
   - docs/ (documentation directory)

Use proper whitespace trimming. These are example entries showing the pattern - actual platform-specific dotfiles will be added in later phases.
  </action>
  <verify>
Run: `chezmoi ignored`
Expected: Shows .planning/, bootstrap.sh, README.md, docs/, etc.

Run: `chezmoi managed --include=files`
Expected: Does NOT include .planning, bootstrap.sh, README.md, docs
  </verify>
  <done>
- .chezmoiignore exists with platform conditional structure
- Planning/docs/bootstrap files are always ignored
- Platform-specific sections ready for future phase additions
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Platform detection works:
   ```bash
   chezmoi execute-template "OS={{ .chezmoi.os }} ARCH={{ .chezmoi.arch }}"
   chezmoi execute-template "Homebrew: {{ .homebrew_prefix }}"
   ```

2. Data section populated:
   ```bash
   chezmoi data --format=yaml
   ```
   Should show homebrew_prefix in output.

3. Ignore patterns work:
   ```bash
   chezmoi ignored
   chezmoi diff
   ```
   Planning files should not appear in diff.

4. Apply runs cleanly:
   ```bash
   chezmoi apply --dry-run
   ```
   No errors, no unexpected files.
</verification>

<success_criteria>
- [ ] chezmoi apply fails with clear error on unsupported OS (not darwin/linux)
- [ ] chezmoi apply fails with clear error on Intel Mac (darwin + amd64)
- [ ] {{ .homebrew_prefix }} returns /opt/homebrew on Apple Silicon Mac
- [ ] {{ .homebrew_prefix }} returns /home/linuxbrew/.linuxbrew on Linux
- [ ] .chezmoiignore excludes planning/bootstrap/docs files on all platforms
- [ ] .chezmoiignore has correct structure for future platform-specific files
- [ ] All existing chezmoi functionality (encryption, bitwarden) still works
</success_criteria>

<output>
After completion, create `.planning/phases/03-cross-platform-support/03-01-SUMMARY.md`
</output>
