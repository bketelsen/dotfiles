---
phase: 05-shell-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl
  - dot_zshenv.tmpl
  - dot_bash_profile
autonomous: true

must_haves:
  truths:
    - "fzf, eza, fd are installed via Homebrew"
    - "zsh-autosuggestions and zsh-syntax-highlighting are installed on macOS"
    - "PATH includes ~/.local/bin and Homebrew prefix on shell startup"
    - ".bash_profile sources .bashrc for consistent bash configuration"
  artifacts:
    - path: ".chezmoiscripts/run_onchange_before_install-packages.sh.tmpl"
      provides: "Declarative package installation"
      contains: "brew \"fzf\""
    - path: "dot_zshenv.tmpl"
      provides: "zsh environment setup (PATH, HOMEBREW_PREFIX)"
      contains: "typeset -U path"
    - path: "dot_bash_profile"
      provides: "bash login shell sources .bashrc"
      contains: "source.*bashrc"
  key_links:
    - from: "dot_zshenv.tmpl"
      to: "Homebrew"
      via: "HOMEBREW_PREFIX export"
      pattern: "export HOMEBREW_PREFIX"
    - from: "dot_bash_profile"
      to: "dot_bashrc"
      via: "source command"
      pattern: "source.*\\.bashrc"
---

<objective>
Install shell enhancement packages (fzf, eza, fd, zsh plugins) and create foundation shell environment files.

Purpose: Provides the tools and PATH setup that .zshrc and .bashrc will integrate with. Fast startup requires HOMEBREW_PREFIX to be cached in environment files rather than computed at runtime.

Output: Updated Brewfile, .zshenv for zsh, .bash_profile for bash
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shell-configuration/05-CONTEXT.md
@.planning/phases/05-shell-configuration/05-RESEARCH.md
@.planning/phases/04-tool-installation/04-01-SUMMARY.md
@.chezmoiscripts/run_onchange_before_install-packages.sh.tmpl
@.chezmoi.toml.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Brewfile with shell enhancement packages</name>
  <files>.chezmoiscripts/run_onchange_before_install-packages.sh.tmpl</files>
  <action>
Update the embedded Brewfile in the run_onchange script to include:

1. Add to the CLI Tools section:
   - `brew "fzf"` - Fuzzy finder for files, history
   - `brew "eza"` - Modern ls replacement (NOT exa - that's unmaintained)
   - `brew "fd"` - Modern find replacement

2. Add macOS-only zsh plugins (inside the existing darwin conditional):
   - `brew "zsh-autosuggestions"` - Fish-like command suggestions
   - `brew "zsh-syntax-highlighting"` - Real-time syntax validation

Keep the existing packages (starship, atuin, bat, direnv) unchanged.
Maintain the heredoc structure and comments.
  </action>
  <verify>
Run `chezmoi cat .chezmoiscripts/run_onchange_before_install-packages.sh.tmpl` and verify:
- fzf, eza, fd appear in CLI Tools section
- zsh-autosuggestions and zsh-syntax-highlighting appear inside darwin conditional
- Existing packages still present
  </verify>
  <done>Brewfile includes all 7 CLI tools plus 2 macOS-only zsh plugins</done>
</task>

<task type="auto">
  <name>Task 2: Create .zshenv for PATH and environment</name>
  <files>dot_zshenv.tmpl</files>
  <action>
Create `dot_zshenv.tmpl` that sets up the shell environment for ALL zsh shells (interactive and non-interactive).

Content should include:
1. HOMEBREW_PREFIX export (cached, not computed at runtime):
   - Darwin: `/opt/homebrew`
   - Linux: `/home/linuxbrew/.linuxbrew`
   Use chezmoi template conditionals.

2. PATH setup using `typeset -U path` for automatic deduplication:
   ```
   typeset -U path
   path=(
     $HOME/.local/bin
     $HOME/bin
     $HOMEBREW_PREFIX/bin
     $HOMEBREW_PREFIX/sbin
     $path
   )
   export PATH
   ```

3. Set EDITOR to `vim` (or `nvim` if preferred)

Keep it minimal - only what ALL shells need. Aliases and functions go in .zshrc.
  </action>
  <verify>
Run `chezmoi cat dot_zshenv.tmpl` and verify:
- HOMEBREW_PREFIX is set conditionally based on OS
- typeset -U path is used for deduplication
- PATH includes ~/.local/bin, ~/bin, and Homebrew paths
  </verify>
  <done>.zshenv configures PATH and HOMEBREW_PREFIX for all zsh shells</done>
</task>

<task type="auto">
  <name>Task 3: Create .bash_profile that sources .bashrc</name>
  <files>dot_bash_profile</files>
  <action>
Create `dot_bash_profile` that follows the standard bash pattern: login shells source .bashrc.

Content:
```bash
# ~/.bash_profile
# Login shells source this file, then we source .bashrc for consistency.
# This ensures all interactive bash shells get the same configuration.

# Source .bashrc if it exists
if [ -f "$HOME/.bashrc" ]; then
    source "$HOME/.bashrc"
fi
```

This is NOT a template (.tmpl) because it's identical on all platforms.
Keep it simple - all real configuration goes in .bashrc.
  </action>
  <verify>
Run `chezmoi cat dot_bash_profile` and verify:
- It sources .bashrc
- Uses proper conditional to check file exists
  </verify>
  <done>.bash_profile sources .bashrc for consistent bash configuration</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `chezmoi diff` shows the three new/modified files
2. Templates parse without errors: `chezmoi execute-template < dot_zshenv.tmpl`
3. Brewfile has all required packages
</verification>

<success_criteria>
- Brewfile includes fzf, eza, fd, zsh-autosuggestions, zsh-syntax-highlighting
- .zshenv sets HOMEBREW_PREFIX and PATH with deduplication
- .bash_profile sources .bashrc
- All files committed to chezmoi source directory
</success_criteria>

<output>
After completion, create `.planning/phases/05-shell-configuration/05-01-SUMMARY.md`
</output>
