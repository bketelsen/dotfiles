---
phase: 05-shell-configuration
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - dot_zshrc.tmpl
autonomous: true

must_haves:
  truths:
    - "zsh on macOS has working starship prompt"
    - "zsh initializes atuin, direnv, and fzf when installed"
    - "zsh completion system uses daily cache for fast startup"
    - "zsh-autosuggestions and zsh-syntax-highlighting are loaded on macOS"
    - "Login shell displays tool status once, subsequent shells are silent"
    - "functions.d directory is sourced if it exists"
  artifacts:
    - path: "dot_zshrc.tmpl"
      provides: "Complete zsh configuration"
      contains: "eval \"$(starship init zsh)\""
  key_links:
    - from: "dot_zshrc.tmpl"
      to: "starship"
      via: "eval init"
      pattern: "starship init zsh"
    - from: "dot_zshrc.tmpl"
      to: "atuin"
      via: "eval init"
      pattern: "atuin init zsh"
    - from: "dot_zshrc.tmpl"
      to: "fzf"
      via: "eval init"
      pattern: "fzf --zsh"
    - from: "dot_zshrc.tmpl"
      to: "functions.d"
      via: "source loop"
      pattern: "functions\\.d.*source"
---

<objective>
Create complete .zshrc configuration with tool integrations, completion caching, plugin loading, and login shell status display.

Purpose: Provides the main interactive zsh configuration for macOS. Prioritizes startup speed (<200ms) through completion caching, conditional tool init, and direct plugin sourcing (no Oh My Zsh).

Output: .zshrc template with full tool integration
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shell-configuration/05-CONTEXT.md
@.planning/phases/05-shell-configuration/05-RESEARCH.md
@.chezmoi.toml.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .zshrc with tool integrations</name>
  <files>dot_zshrc.tmpl</files>
  <action>
Create `dot_zshrc.tmpl` with the following sections IN ORDER (order matters for zsh):

1. **Profiling (commented out)** - zprof for debugging startup time

2. **History configuration:**
   ```zsh
   HISTFILE=~/.zsh_history
   HISTSIZE=50000
   SAVEHIST=50000
   setopt SHARE_HISTORY
   setopt HIST_IGNORE_DUPS
   setopt HIST_IGNORE_SPACE
   ```

3. **Completion system with daily cache:**
   ```zsh
   autoload -Uz compinit
   if [[ -n ${ZDOTDIR:-$HOME}/.zcompdump(#qN.mh+24) ]]; then
     compinit
   else
     compinit -C
   fi
   ```

4. **Tool integrations (conditional on tool existence):**
   - starship: `command -v starship >/dev/null 2>&1 && eval "$(starship init zsh)"`
   - atuin: `command -v atuin >/dev/null 2>&1 && eval "$(atuin init zsh)"`
   - direnv: `command -v direnv >/dev/null 2>&1 && eval "$(direnv hook zsh)"`
   - fzf: Initialize with `eval "$(fzf --zsh)"` BUT disable Ctrl-R if atuin is present:
     ```zsh
     if command -v fzf >/dev/null 2>&1; then
       if command -v atuin >/dev/null 2>&1; then
         export FZF_CTRL_R_COMMAND=""
       fi
       eval "$(fzf --zsh)"
     fi
     ```

5. **functions.d sourcing:**
   ```zsh
   if [[ -d "$HOME/.zsh/functions.d" ]]; then
     for func_file in $HOME/.zsh/functions.d/*.sh(N); do
       source "$func_file"
     done
   fi
   ```
   Note: (N) is zsh NULL_GLOB - prevents error if no matches.

6. **macOS-only: zsh plugins (use chezmoi template):**
   ```
   {{- if eq .chezmoi.os "darwin" }}
   # zsh-autosuggestions
   if [[ -f $HOMEBREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]]; then
     source $HOMEBREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh
   fi
   {{- end }}
   ```

7. **Login shell status display (BEFORE syntax highlighting):**
   ```zsh
   if [[ -o login ]]; then
     echo "Shell: zsh $(zsh --version | cut -d' ' -f2)"
     echo ""
     echo "Tools:"
     command -v starship >/dev/null 2>&1 && echo "  + starship" || echo "  - starship (not found)"
     command -v atuin >/dev/null 2>&1 && echo "  + atuin" || echo "  - atuin (not found)"
     command -v direnv >/dev/null 2>&1 && echo "  + direnv" || echo "  - direnv (not found)"
     command -v fzf >/dev/null 2>&1 && echo "  + fzf" || echo "  - fzf (not found)"
     echo ""
     echo "Aliases:"
     command -v bat >/dev/null 2>&1 && echo "  + cat -> bat" || echo "  - bat (not found)"
     command -v eza >/dev/null 2>&1 && echo "  + ls -> eza" || echo "  - eza (not found)"
     command -v fd >/dev/null 2>&1 && echo "  + find -> fd" || echo "  - fd (not found)"
     echo ""
   fi
   ```

8. **macOS-only: zsh-syntax-highlighting MUST BE LAST:**
   ```
   {{- if eq .chezmoi.os "darwin" }}
   # zsh-syntax-highlighting (MUST be last)
   if [[ -f $HOMEBREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]]; then
     source $HOMEBREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
   fi
   {{- end }}
   ```

Use `$HOMEBREW_PREFIX` (set in .zshenv) rather than `$(brew --prefix)` to avoid 10-20ms penalty per call.
  </action>
  <verify>
Run `chezmoi cat dot_zshrc.tmpl` and verify:
- Completion caching uses the daily regeneration pattern
- All tool integrations are conditional on command existence
- fzf disables Ctrl-R when atuin is present
- functions.d sourcing uses NULL_GLOB
- zsh-syntax-highlighting is absolutely last
- Login shell detection uses `[[ -o login ]]`
  </verify>
  <done>.zshrc provides complete zsh configuration with fast startup and tool integration</done>
</task>

</tasks>

<verification>
After task completes:
1. Template parses: `chezmoi execute-template < dot_zshrc.tmpl` (on macOS for full output)
2. No syntax errors: `zsh -n` on generated output
3. Order is correct: syntax-highlighting is last
</verification>

<success_criteria>
- .zshrc configures completion with daily caching
- starship, atuin, direnv, fzf initialized conditionally
- fzf Ctrl-R disabled when atuin present
- zsh plugins sourced on macOS only
- Login shell shows tool status
- functions.d sourced if exists
- zsh-syntax-highlighting is absolutely last in file
</success_criteria>

<output>
After completion, create `.planning/phases/05-shell-configuration/05-02-SUMMARY.md`
</output>
