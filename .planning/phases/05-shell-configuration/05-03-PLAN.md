---
phase: 05-shell-configuration
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - dot_bashrc.tmpl
autonomous: true

must_haves:
  truths:
    - "bash on Linux has working starship prompt"
    - "bash initializes atuin, direnv, and fzf when installed"
    - "Login shell displays tool status once, subsequent shells are silent"
    - "functions.d directory is sourced if it exists"
    - "PATH deduplication prevents accumulation in nested shells"
  artifacts:
    - path: "dot_bashrc.tmpl"
      provides: "Complete bash configuration"
      contains: "eval \"$(starship init bash)\""
  key_links:
    - from: "dot_bashrc.tmpl"
      to: "starship"
      via: "eval init"
      pattern: "starship init bash"
    - from: "dot_bashrc.tmpl"
      to: "atuin"
      via: "eval init"
      pattern: "atuin init bash"
    - from: "dot_bashrc.tmpl"
      to: "fzf"
      via: "eval init"
      pattern: "fzf --bash"
    - from: "dot_bashrc.tmpl"
      to: "functions.d"
      via: "source loop"
      pattern: "functions\\.d.*source"
---

<objective>
Create complete .bashrc configuration with tool integrations and login shell status display.

Purpose: Provides the main interactive bash configuration for Linux. Matches zsh feature parity where possible, with bash-specific syntax adaptations.

Output: .bashrc template with full tool integration
</objective>

<execution_context>
@/home/bjk/.claude/get-shit-done/workflows/execute-plan.md
@/home/bjk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shell-configuration/05-CONTEXT.md
@.planning/phases/05-shell-configuration/05-RESEARCH.md
@.chezmoi.toml.tmpl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create .bashrc with tool integrations</name>
  <files>dot_bashrc.tmpl</files>
  <action>
Create `dot_bashrc.tmpl` with the following sections:

1. **Early exit for non-interactive shells:**
   ```bash
   # If not running interactively, don't do anything
   case $- in
       *i*) ;;
         *) return;;
   esac
   ```

2. **Homebrew environment (for Linux):**
   ```bash
   # Homebrew on Linux
   {{- if eq .chezmoi.os "linux" }}
   export HOMEBREW_PREFIX="/home/linuxbrew/.linuxbrew"
   eval "$($HOMEBREW_PREFIX/bin/brew shellenv)"
   {{- end }}
   ```

3. **PATH deduplication function and setup:**
   ```bash
   # Add to PATH only if not already present
   add_to_path() {
     case ":$PATH:" in
       *":$1:"*) ;;
       *) PATH="$1:$PATH" ;;
     esac
   }

   add_to_path "$HOME/.local/bin"
   add_to_path "$HOME/bin"
   ```

4. **History configuration:**
   ```bash
   HISTFILE=~/.bash_history
   HISTSIZE=50000
   HISTFILESIZE=50000
   HISTCONTROL=ignoreboth:erasedups
   shopt -s histappend
   ```

5. **Shell options:**
   ```bash
   shopt -s checkwinsize  # Update LINES and COLUMNS after each command
   shopt -s globstar 2>/dev/null  # ** matches recursively (bash 4+)
   ```

6. **Tool integrations (conditional):**
   ```bash
   # starship prompt
   if command -v starship >/dev/null 2>&1; then
     eval "$(starship init bash)"
   fi

   # atuin history
   if command -v atuin >/dev/null 2>&1; then
     eval "$(atuin init bash)"
   fi

   # direnv
   if command -v direnv >/dev/null 2>&1; then
     eval "$(direnv hook bash)"
   fi

   # fzf - disable Ctrl-R if atuin is present
   if command -v fzf >/dev/null 2>&1; then
     if command -v atuin >/dev/null 2>&1; then
       export FZF_CTRL_R_COMMAND=""
     fi
     eval "$(fzf --bash)"
   fi
   ```

7. **functions.d sourcing:**
   ```bash
   if [ -d "$HOME/.bash/functions.d" ]; then
     for func_file in "$HOME/.bash/functions.d"/*.sh; do
       if [ -f "$func_file" ]; then
         source "$func_file"
       fi
     done
   fi
   ```

8. **Login shell status display:**
   ```bash
   if shopt -q login_shell; then
     echo "Shell: bash $BASH_VERSION"
     echo ""
     echo "Tools:"
     command -v starship >/dev/null 2>&1 && echo "  + starship" || echo "  - starship (not found)"
     command -v atuin >/dev/null 2>&1 && echo "  + atuin" || echo "  - atuin (not found)"
     command -v direnv >/dev/null 2>&1 && echo "  + direnv" || echo "  - direnv (not found)"
     command -v fzf >/dev/null 2>&1 && echo "  + fzf" || echo "  - fzf (not found)"
     echo ""
     echo "Aliases:"
     command -v bat >/dev/null 2>&1 && echo "  + cat -> bat" || echo "  - bat (not found)"
     command -v eza >/dev/null 2>&1 && echo "  + ls -> eza" || echo "  - eza (not found)"
     command -v fd >/dev/null 2>&1 && echo "  + find -> fd" || echo "  - fd (not found)"
     echo ""
   fi
   ```

Note: bash uses `shopt -q login_shell` vs zsh's `[[ -o login ]]`.
Use POSIX-compatible constructs where possible for reliability.
  </action>
  <verify>
Run `chezmoi cat dot_bashrc.tmpl` and verify:
- Early exit for non-interactive shells
- PATH deduplication function exists
- All tool integrations are conditional
- fzf disables Ctrl-R when atuin present
- functions.d sourcing handles missing directory
- Login shell detection uses `shopt -q login_shell`
  </verify>
  <done>.bashrc provides complete bash configuration with tool integration</done>
</task>

</tasks>

<verification>
After task completes:
1. Template parses: `chezmoi execute-template < dot_bashrc.tmpl` (on Linux for full output)
2. No syntax errors: `bash -n` on generated output
3. Matches zsh feature parity (same tools, same status output format)
</verification>

<success_criteria>
- .bashrc handles non-interactive shells gracefully
- PATH deduplication prevents nested shell accumulation
- starship, atuin, direnv, fzf initialized conditionally
- fzf Ctrl-R disabled when atuin present
- Login shell shows tool status (same format as zsh)
- functions.d sourced if exists
</success_criteria>

<output>
After completion, create `.planning/phases/05-shell-configuration/05-03-SUMMARY.md`
</output>
